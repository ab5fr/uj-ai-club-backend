services:
  api-1:
    image: ${API_IMAGE:-ghcr.io/ab5fr/uj-ai-club-backend-api:latest}
    env_file: .env
    volumes:
      - uploads_data:/app/uploads
    networks:
      proxy: {}
      internal:
        aliases:
          - backend
    labels:
      - com.centurylinklabs.watchtower.enable=true
    restart: unless-stopped

  api-2:
    image: ${API_IMAGE:-ghcr.io/ab5fr/uj-ai-club-backend-api:latest}
    env_file: .env
    volumes:
      - uploads_data:/app/uploads
    networks:
      proxy: {}
      internal:
        aliases:
          - backend
    labels:
      - com.centurylinklabs.watchtower.enable=true
    restart: unless-stopped

  api-3:
    image: ${API_IMAGE:-ghcr.io/ab5fr/uj-ai-club-backend-api:latest}
    env_file: .env
    volumes:
      - uploads_data:/app/uploads
    networks:
      proxy: {}
      internal:
        aliases:
          - backend
    labels:
      - com.centurylinklabs.watchtower.enable=true
    restart: unless-stopped

  jupyterhub:
    image: ${JUPYTERHUB_IMAGE:-ghcr.io/ab5fr/uj-ai-club-backend-jupyterhub:latest}
    env_file: .env
    environment:
      - DOCKER_NETWORK_NAME=internal
      - JUPYTERHUB_HUB_CONNECT_IP=jupyterhub
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - nbgrader_exchange:/srv/nbgrader/exchange
      - jupyterhub_data:/data
    networks:
      - proxy
      - internal
    labels:
      - com.centurylinklabs.watchtower.enable=true
    restart: unless-stopped

  grading:
    image: ${GRADING_IMAGE:-ghcr.io/ab5fr/uj-ai-club-backend-grading:latest}
    env_file: .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - uploads_data:/srv/notebooks
      - nbgrader_exchange:/srv/nbgrader/exchange
      - nbgrader_course:/srv/nbgrader/course
      - nbgrader_data:/data
    networks:
      - internal
    labels:
      - com.centurylinklabs.watchtower.enable=true
    restart: unless-stopped

  nginx:
    image: nginx:latest
    volumes:
      - ./infra/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./infra/certbot/www:/var/www/certbot
      - ./infra/certbot/conf:/etc/letsencrypt
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - api-1
      - api-2
      - api-3
      - jupyterhub
    networks:
      - proxy
    labels:
      - com.centurylinklabs.watchtower.enable=true
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./infra/certbot/www:/var/www/certbot
      - ./infra/certbot/conf:/etc/letsencrypt
    entrypoint: /bin/sh -c "trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot; sleep 12h; done"
    restart: unless-stopped

  watchtower:
    image: containrrr/watchtower:latest
    command: --label-enable --cleanup --rolling-restart --interval 60
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

volumes:
  uploads_data:
  nbgrader_exchange:
  nbgrader_course:
  nbgrader_data:
  jupyterhub_data:

networks:
  proxy:
  internal:
    name: internal
    internal: true
